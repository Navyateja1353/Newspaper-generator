<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Janam News - ZIP Newspaper Generator</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;500;700&display=swap');

/* ‚úÖ PRINT MARGINS (ONLY ADDITION) */
@page {
    size: A4;
    margin: 12mm;
}

body {
    font-family: 'Noto Sans Telugu', sans-serif;
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
}

.app {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 25px;
    box-shadow: 0 25px 80px rgba(0,0,0,0.25);
    overflow: hidden;
}

.header {
    background: linear-gradient(45deg, #dc2626, #b91c1c);
    color: white;
    padding: 50px;
    text-align: center;
}

.header h1 {
    font-size: 3rem;
    font-weight: 700;
}

.drop-zone {
    border: 5px dashed #3b82f6;
    border-radius: 20px;
    padding: 80px;
    text-align: center;
    margin: 50px;
    cursor: pointer;
}

.dual-panel {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    padding: 40px;
}

.panel {
    background: #f8fafc;
    border-radius: 20px;
    padding: 30px; /* reduced for print safety */
    height: 700px;
    overflow-y: auto;
}

.story-item {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
}

.story-image {
    width: 100%;
    height: 250px;
    object-fit: cover;
    border-radius: 12px;
    margin: 15px 0;
}

/* ‚úÖ SAFE PRINT WIDTH */
.newspaper-preview {
    column-count: 3;
    column-gap: 20px;
    width: 100%;
    max-width: 186mm;
    margin: 0 auto;
}

.print-btn {
    background: linear-gradient(45deg, #ec4899, #db2777);
    border: none;
    color: white;
    padding: 20px 60px;
    font-size: 1.5rem;
    border-radius: 50px;
    font-weight: 700;
}

/* ‚úÖ PRINT SAFETY */
@media print {
    body {
        background: white;
    }

    .panel {
        overflow: visible !important;
    }

    .newspaper-preview {
        column-fill: auto;
    }

    .drop-zone,
    .print-btn {
        display: none !important;
    }
}
</style>
</head>

<body>

<div class="app">
    <div class="header">
        <h1>üì∞ ‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç</h1>
        <p>ZIP ‚Üí Newspaper</p>
    </div>

    <div class="drop-zone" id="dropZone">
        <h2>ZIP File Upload</h2>
        <input type="file" id="zipInput" accept=".zip" hidden>
        <button class="btn btn-primary btn-lg mt-3" onclick="zipInput.click()">Select ZIP</button>
    </div>

    <div class="dual-panel">
        <div class="panel">
            <h3>Extracted Stories</h3>
            <div id="storiesList"></div>
        </div>

        <div class="panel">
            <button class="print-btn mb-4" id="printBtn">üñ®Ô∏è Print PDF</button>
            <div id="newspaperPreview" class="newspaper-preview"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
let extractedStories = [];
let imageMap = {};

zipInput.onchange = async e => processZip(e.target.files[0]);

async function processZip(file) {
    const zip = await JSZip.loadAsync(file);
    imageMap = {};

    for (let f in zip.files) {
        if (f.match(/\.(jpg|jpeg|png)$/i)) {
            const blob = await zip.file(f).async("blob");
            imageMap[f] = URL.createObjectURL(blob);
        }
    }

    const txt = Object.keys(zip.files).find(f => f.endsWith(".txt"));
    const content = await zip.file(txt).async("text");

    extractedStories = parseChat(content);
    renderStories();
    generateNewspaper();
}

function parseChat(text) {
    const lines = text.split("\n");
    let stories = [];
    let cur = { text: "", images: [] };

    lines.forEach(l => {
        if (l.includes("This message was deleted")) return;

        if (/END|üîö/i.test(l)) {
            if (cur.text.length > 50) stories.push(cur);
            cur = { text: "", images: [] };
            return;
        }

        const img = l.match(/<attached:\s*(.*?\.(jpg|jpeg|png))/i);
        if (img && imageMap[img[1]]) {
            cur.images.push(imageMap[img[1]]);
        } else {
            cur.text += l + " ";
        }
    });

    return stories;
}

function renderStories() {
    storiesList.innerHTML = extractedStories.map((s,i)=>`
        <div class="story-item">
            <b>Story ${i+1}</b>
            <p>${s.text.slice(0,300)}...</p>
        </div>
    `).join("");
}

function generateNewspaper() {
    newspaperPreview.innerHTML = extractedStories.map(s=>`
        <div style="break-inside:avoid; margin-bottom:20px">
            <h4>${s.text.split(" ").slice(0,8).join(" ")}...</h4>
            ${s.images[0] ? `<img src="${s.images[0]}" style="width:100%;height:200px;object-fit:cover">` : ""}
            <p>${s.text.slice(0,700)}</p>
        </div>
    `).join("");
}

printBtn.onclick = () => window.print();
</script>

</body>
</html>
