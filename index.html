<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="UTF-8">
<title>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç - ‡∞∏‡∞Ç‡∞™‡±Ç‡∞∞‡±ç‡∞£ ‡∞é‡∞°‡∞ø‡∞∑‡∞®‡±ç</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    @page { size: A4; margin: 0; }
    body { background: #333; font-family: 'Noto Sans Telugu', sans-serif; padding-bottom: 50px; }

    .page {
        width: 210mm; height: 297mm; background: white; margin: 10mm auto;
        padding: 12mm; position: relative; page-break-after: always;
        border: 6px double black; overflow: hidden;
    }

    .header { text-align: center; border-bottom: 3px solid black; margin-bottom: 5mm; }
    .header h1 { font-size: 55px; font-weight: 800; color: #b91c1c; }
    
    .header-meta {
        display: flex; justify-content: space-between; font-weight: bold;
        font-size: 14px; border-top: 1px solid black; padding: 5px 10px;
    }

    /* 3 Column Layout */
    .columns {
        column-count: 3; column-gap: 20px; column-rule: 1px solid #000;
        height: calc(297mm - 75mm); width: 100%;
    }

    /* Article Box - Strictly follows Image -> Text sequence */
    .news-box {
        break-inside: avoid; border: 1.5px solid #000;
        margin-bottom: 20px; padding: 10px; background: #fff;
    }

    .news-box h2 {
        font-size: 16px; margin-bottom: 8px; color: #000;
        border-bottom: 2px solid #b91c1c; padding-bottom: 3px;
    }

    .news-box img {
        width: 100%; max-height: 250px; object-fit: contain;
        margin-bottom: 10px; border: 1px solid #ddd;
    }

    .news-box p {
        font-size: 12.5px; line-height: 1.85; /* Increased to fill gaps */
        text-align: justify; color: #111;
    }

    /* Filler Text for White Space */
    .filler-box {
        break-inside: avoid; background: #f0f0f0;
        border: 1px dashed #444; padding: 10px; font-size: 11px;
    }

    #ui { background: white; padding: 20px; text-align: center; border-bottom: 5px solid #b91c1c; position: sticky; top:0; z-index:100; }
</style>
</head>
<body>

<div id="ui">
    <h2>üì∞ ‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç - Final Web Version</h2>
    <input type="file" id="zipInput" accept=".zip">
    <p class="small mt-2">No Names | Images Linked to Text | 3 Columns | Automatic Filling</p>
</div>

<div id="paper"></div>

<script>
let imageMap = {};
const TOTAL_PAGES = 10;

zipInput.onchange = async e => {
    const zip = await JSZip.loadAsync(e.target.files[0]);
    imageMap = {};
    
    // 1. Map Images
    for (let f in zip.files) {
        if (f.match(/\.(jpg|jpeg|png)$/i)) {
            const blob = await zip.file(f).async("blob");
            imageMap[f.split('/').pop()] = URL.createObjectURL(blob);
        }
    }

    // 2. Parse Text - Linked Logic
    const txtFile = Object.keys(zip.files).find(f => f.endsWith(".txt"));
    const text = await zip.file(txtFile).async("text");
    const newsData = parseData(text);
    render(newsData);
};

function parseData(text) {
    const lines = text.split("\n");
    let articles = [];
    let current = { text: "", image: null };

    lines.forEach(line => {
        // Remove names (Chinni, Lakshman, etc) using regex
        const match = line.match(/\[.*?\]\s*~?.*?\s*:\s*(.*)/);
        if (!match) return;

        let content = match[1].trim();
        if (content.includes("deleted") || content.includes("omitted")) return;

        // Check for Image
        const imgMatch = content.match(/<attached:\s*(.*?\.(jpg|jpeg|png))/i);
        if (imgMatch) {
            // Save existing text before starting new image block
            if (current.text.length > 30) articles.push({...current});
            current = { text: "", image: imageMap[imgMatch[1].trim()] };
        } else if (/END|üîö/i.test(content)) {
            if (current.text.length > 30) articles.push({...current});
            current = { text: "", image: null };
        } else {
            current.text += content + " ";
        }
    });
    if (current.text.length > 30) articles.push(current);
    return articles;
}

function render(data) {
    const paper = document.getElementById("paper");
    paper.innerHTML = "";
    const perPage = Math.ceil(data.length / TOTAL_PAGES);
    let idx = 0;

    for (let p = 1; p <= TOTAL_PAGES; p++) {
        const page = document.createElement("div");
        page.className = "page";
        page.innerHTML = `
            <div class="header">
                <h1>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç</h1>
                <div class="header-meta">
                    <span>‡∞®‡∞ø‡∞ú‡∞æ‡∞Ø‡∞ø‡∞§‡±Ä ‡∞ó‡∞≤ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞≤‡±Å</span>
                    <span>‡∞§‡±á‡∞¶‡±Ä: ${new Date().toLocaleDateString('te-IN')}</span>
                    <span>‡∞™‡±á‡∞ú‡±Ä: ${p}</span>
                </div>
            </div>
            <div class="columns"></div>
        `;

        const col = page.querySelector(".columns");
        for (let i = 0; i < perPage && idx < data.length; i++, idx++) {
            const item = data[idx];
            const box = document.createElement("div");
            box.className = "news-box";
            const head = item.text.split(" ").slice(0, 6).join(" ") + "...";
            box.innerHTML = `
                <h2>${head}</h2>
                ${item.image ? `<img src="${item.image}">` : ""}
                <p>${item.text}</p>
            `;
            col.appendChild(box);
        }

        // Space Filler
        if (idx < data.length) {
            const filler = document.createElement("div");
            filler.className = "filler-box";
            filler.innerHTML = "<b>‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï:</b> ‡∞Æ‡∞∞‡∞ø‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞≤‡±Å, ‡∞µ‡∞ø‡∞∂‡±á‡∞∑‡∞æ‡∞≤ ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç ‡∞¶‡∞ø‡∞®‡∞™‡∞§‡±ç‡∞∞‡∞ø‡∞ï‡∞®‡±Å ‡∞™‡±ç‡∞∞‡∞§‡∞ø‡∞∞‡±ã‡∞ú‡±Ç ‡∞ö‡∞¶‡∞µ‡∞Ç‡∞°‡∞ø. ‡∞Æ‡±Ä ‡∞™‡∞∞‡∞ø‡∞∏‡∞∞‡∞æ‡∞≤‡±ç‡∞≤‡±ã‡∞®‡∞ø ‡∞∏‡∞Æ‡∞∏‡±ç‡∞Ø‡∞≤‡∞®‡±Å ‡∞Æ‡∞æ ‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‚Äå‡∞ï‡±Å ‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø.";
            col.appendChild(filler);
        }

        paper.appendChild(page);
    }
}
</script>
</body>
</html>
