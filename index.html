<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <title>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç - Newspaper Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        @media print {
            #ui { display: none; }
            body { background: white; }
            .page { margin: 0; border: none; }
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background: #333;
            font-family: 'Noto Sans Telugu', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #ui {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            border-bottom: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .page {
            width: 210mm;
            height: 297mm;
            background: white;
            margin: 20px 0;
            padding: 12mm;
            border: 6px double black;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            border-bottom: 4px solid black;
            margin-bottom: 5mm;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 55px;
            color: #b91c1c;
            margin: 0;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .meta {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: bold;
            border-top: 1px solid black;
            padding: 4px 10px;
            margin-top: 5px;
        }

        .columns {
            column-count: 3;
            column-gap: 15px;
            column-rule: 0.5px solid #aaa;
            flex-grow: 1;
            text-align: justify;
            /* Height must be controlled to trigger column wrap */
            height: 235mm; 
        }

        .article {
            break-inside: avoid;
            border-bottom: 1px solid #ccc;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .article h2 {
            font-size: 15px;
            line-height: 1.3;
            color: #000;
            margin-top: 0;
            border-bottom: 2px solid #b91c1c;
            display: inline-block;
            margin-bottom: 6px;
        }

        .article img {
            width: 100%;
            max-height: 180px;
            object-fit: cover;
            margin: 5px 0;
            border: 1px solid #ddd;
        }

        .article p {
            font-size: 11px;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
            color: #222;
        }

        button {
            padding: 10px 20px;
            background: #b91c1c;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        button:hover { background: #991b1b; }
    </style>
</head>

<body>

<div id="ui">
    <h3>üì∞ ‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç ‚Äì Newspaper Generator</h3>
    <input type="file" id="zipInput" accept=".zip">
    <button onclick="window.print()">Print to PDF</button>
</div>

<div id="paper"></div>

<script>
    let imageMap = {};

    document.getElementById('zipInput').onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;

        const zip = await JSZip.loadAsync(file);
        imageMap = {};

        // 1. Process Images
        for (const filename in zip.files) {
            if (/\.(jpg|jpeg|png)$/i.test(filename)) {
                const blob = await zip.file(filename).async("blob");
                imageMap[filename.split("/").pop()] = URL.createObjectURL(blob);
            }
        }

        // 2. Process Text
        const txtFile = Object.keys(zip.files).find(f => f.endsWith(".txt"));
        if (!txtFile) {
            alert("No .txt file found in ZIP");
            return;
        }
        const text = await zip.file(txtFile).async("text");

        const articles = parseArticles(text);
        renderPages(articles);
    };

    function parseArticles(text) {
        const lines = text.split(/\r?\n/);
        let articles = [];
        let buffer = "";
        let currentImage = null;

        const pushArticle = () => {
            if (buffer.trim().length > 50) {
                articles.push({ 
                    text: buffer.trim(), 
                    image: currentImage 
                });
            }
            buffer = "";
            currentImage = null;
        };

        lines.forEach(line => {
            // Remove WhatsApp timestamps/metadata if present
            line = line.replace(/^\[[^\]]+\]\s*[^:]+:\s*/, "").trim();
            if (!line || /image omitted|^end$/i.test(line)) return;

            // Detect image tags
            const imgMatch = line.match(/<attached:\s*(.*?\.(jpg|jpeg|png))/i);
            if (imgMatch) {
                if (buffer) pushArticle();
                currentImage = imageMap[imgMatch[1]];
                return;
            }

            // Logic to separate stories: if line is short and we have content, it's a new headline
            if (line.length < 60 && buffer.length > 300) {
                pushArticle();
            }
            buffer += line + "\n";
        });

        pushArticle();
        return articles;
    }

    function titleFrom(text) {
        return text.split("\n")[0].substring(0, 70);
    }

    function createNewPage(num) {
        const page = document.createElement("div");
        page.className = "page";
        page.innerHTML = `
            <div class="header">
                <h1>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç</h1>
                <div class="meta">
                    <span>‡∞∏‡∞Ç‡∞™‡±Å‡∞ü‡∞ø 1 | ‡∞∏‡∞Ç‡∞ö‡∞ø‡∞ï ${num}</span>
                    <span>‡∞§‡±á‡∞¶‡±Ä: ${new Date().toLocaleDateString('te-IN')}</span>
                    <span>‡∞™‡±á‡∞ú‡±Ä: ${num}</span>
                </div>
            </div>
            <div class="columns"></div>
        `;
        document.getElementById('paper').appendChild(page);
        return page.querySelector(".columns");
    }

    async function renderPages(articles) {
        const paper = document.getElementById('paper');
        paper.innerHTML = "";
        
        let pageNum = 1;
        let currentColumnContainer = createNewPage(pageNum);

        for (const artData of articles) {
            const artEl = document.createElement("div");
            artEl.className = "article";
            
            // Generate content
            const title = titleFrom(artData.text);
            const content = artData.text.replace(title, "").trim();
            
            artEl.innerHTML = `
                <h2>${title}</h2>
                ${artData.image ? `<img src="${artData.image}">` : ""}
                <p>${content}</p>
            `;

            currentColumnContainer.appendChild(artEl);

            // Check if current article pushed the page over the limit
            // A4 page content height is roughly 900-1000px
            if (currentColumnContainer.scrollHeight > 920) {
                // If it overflows, move this article to a new page
                currentColumnContainer.removeChild(artEl);
                pageNum++;
                currentColumnContainer = createNewPage(pageNum);
                currentColumnContainer.appendChild(artEl);
            }
        }
    }
</script>

</body>
</html>
