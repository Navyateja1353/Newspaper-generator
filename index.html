<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="UTF-8">
<title>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç ‚Äì AI Newspaper</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

@page { size: A4; margin: 12mm; }

body {
    background: #bbb;
    font-family: 'Noto Sans Telugu', sans-serif;
}

/* PAGE */
.page {
    width: 210mm;
    height: 297mm;
    background: #fff;
    margin: 10mm auto;
    padding: 12mm;
    page-break-after: always;
    overflow: hidden;
    border: 1px solid #000;
}

/* HEADER */
.header {
    text-align: center;
    border-bottom: 4px solid #000;
    padding-bottom: 6px;
    margin-bottom: 6px;
}

.header h1 { font-size: 36px; }

/* FRONT BANNER */
.banner {
    border: 3px solid #000;
    padding: 8px;
    margin-bottom: 8px;
}

.banner h2 {
    font-size: 22px;
    text-align: center;
}

/* CONTENT */
.columns {
    column-count: 4;
    column-gap: 10px;
    height: calc(297mm - 80mm);
}

/* SECTION */
.section {
    font-size: 13px;
    font-weight: 700;
    background: #000;
    color: #fff;
    padding: 3px;
    margin-bottom: 4px;
}

/* ARTICLE */
.article {
    break-inside: avoid;
    border: 1px solid #000;
    padding: 6px;
    margin-bottom: 6px;
}

.article h3 {
    font-size: 14px;
    border-bottom: 1px solid #000;
    margin-bottom: 4px;
}

.article img {
    width: 100%;
    height: 90px;
    object-fit: cover;
    border: 1px solid #000;
    margin: 4px 0;
}

.article p {
    font-size: 11px;
    line-height: 1.45;
    text-align: justify;
}

/* CONTROLS */
#upload {
    background: white;
    padding: 10px;
    text-align: center;
    margin: 10px;
}

@media print {
    body { background: none; }
    #upload { display: none; }
    .page { margin: 0; }
}
</style>
</head>

<body>

<div id="upload">
    <input type="file" id="zipInput" accept=".zip">
    <button onclick="printPDF()">üñ®Ô∏è PDF PRINT</button>
</div>

<div id="paper"></div>

<script>
let imageMap = {};
let articles = [];
const MAX_PAGES = 8;

zipInput.onchange = async e => {
    const zip = await JSZip.loadAsync(e.target.files[0]);

    imageMap = {};
    for (let f in zip.files) {
        if (/\.(jpg|jpeg|png)$/i.test(f)) {
            const blob = await zip.file(f).async("blob");
            imageMap[f] = URL.createObjectURL(blob);
        }
    }

    const txt = Object.keys(zip.files).find(f => f.endsWith(".txt"));
    const text = await zip.file(txt).async("text");

    articles = parse(text);
    render();
};

function valid(t) {
    return t && !t.includes("This message was deleted") && t.length > 120;
}

function section(text) {
    if (/‡∞Æ‡∞Ç‡∞§‡±ç‡∞∞‡∞ø|‡∞é‡∞Æ‡±ç‡∞Æ‡±Ü‡∞≤‡±ç‡∞Ø‡±á|‡∞™‡±ç‡∞∞‡∞≠‡±Å‡∞§‡±ç‡∞µ‡∞Ç/.test(text)) return "‡∞∞‡∞æ‡∞ú‡∞ï‡±Ä‡∞Ø‡∞Ç";
    if (/‡∞Ö‡∞∞‡±Ü‡∞∏‡±ç‡∞ü‡±ç|‡∞ï‡±á‡∞∏‡±Å|‡∞¶‡∞æ‡∞°‡∞ø/.test(text)) return "‡∞®‡±á‡∞∞ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞≤‡±Å";
    if (/‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡∞Ç|‡∞Æ‡∞Ç‡∞°‡∞≤‡∞Ç|‡∞ú‡∞ø‡∞≤‡±ç‡∞≤‡∞æ/.test(text)) return "‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞ø‡∞ï‡∞Ç";
    if (/‡∞™‡∞Ç‡∞™‡∞ø‡∞£‡±Ä|‡∞™‡∞•‡∞ï‡∞Ç|‡∞∏‡∞π‡∞æ‡∞Ø‡∞Ç/.test(text)) return "‡∞∏‡∞Ç‡∞ï‡±ç‡∞∑‡±á‡∞Æ‡∞Ç";
    return "‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞µ‡∞æ‡∞∞‡±ç‡∞§‡∞≤‡±Å";
}

function parse(text) {
    let res = [], cur = { text: "", image: null };
    text.split("\n").forEach(l => {
        let m = l.match(/\[(.*?)\]\s*~.*?:\s*(.*)/);
        if (!m) return;
        let msg = m[2];
        if (/END|üîö/.test(msg)) {
            if (valid(cur.text)) res.push(cur);
            cur = { text: "", image: null };
            return;
        }
        let im = msg.match(/<attached:\s*(.*?\.(jpg|jpeg|png))/i);
        if (im && imageMap[im[1]]) cur.image = imageMap[im[1]];
        else if (valid(msg)) cur.text += msg + " ";
    });
    if (valid(cur.text)) res.push(cur);
    return res;
}

function title(t) {
    return t.split(" ").slice(0, 7).join(" ") + "...";
}

function render() {
    const paper = document.getElementById("paper");
    paper.innerHTML = "";
    let idx = 0;

    for (let p = 1; p <= MAX_PAGES && idx < articles.length; p++) {
        let page = document.createElement("div");
        page.className = "page";
        page.innerHTML = `
            <div class="header"><h1>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç</h1></div>
            ${p === 1 ? `<div class="banner"><h2>${title(articles[0].text)}</h2></div>` : ""}
            <div class="columns"></div>
        `;
        paper.appendChild(page);

        let col = page.querySelector(".columns");
        while (idx < articles.length) {
            let a = articles[idx];
            let box = document.createElement("div");
            box.innerHTML = `
                <div class="section">${section(a.text)}</div>
                <div class="article">
                    <h3>${title(a.text)}</h3>
                    ${a.image ? `<img src="${a.image}">` : ""}
                    <p>${a.text}</p>
                </div>
            `;
            col.appendChild(box);
            if (col.scrollHeight > col.clientHeight) {
                col.removeChild(box);
                break;
            }
            idx++;
        }
    }
}

function printPDF() {
    window.print();
}
</script>

</body>
</html>
