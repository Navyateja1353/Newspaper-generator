<!DOCTYPE html>
<html lang="te">
<head>
<meta charset="UTF-8">
<title>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;600;700&display=swap" rel="stylesheet">

<style>
@page { size: A4; margin: 0; }
* { box-sizing: border-box; }

body {
    margin: 0;
    background: #333;
    font-family: 'Noto Sans Telugu', sans-serif;
}

#ui {
    background: white;
    padding: 14px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.page {
    width: 210mm;
    height: 297mm;
    background: white;
    margin: 12px auto;
    padding: 12mm;
    border: 6px double black;
    page-break-after: always;
}

.header {
    text-align: center;
    border-bottom: 3px solid black;
    margin-bottom: 6mm;
}

.header h1 {
    font-size: 46px;
    color: #b91c1c;
    font-weight: 800;
}

.meta {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    font-weight: bold;
    border-top: 1px solid black;
    padding: 4px 10px;
}

.columns {
    column-count: 3;
    column-gap: 14px;
    column-rule: 0.5px solid #aaa;
    height: 230mm;
    text-align: justify;
}

.article {
    break-inside: avoid;
    border: 1px solid black;
    padding: 7px;
    margin-bottom: 12px;
}

.article h2 {
    font-size: 14px;
    border-bottom: 2px solid #b91c1c;
    margin-bottom: 6px;
}

.article img {
    width: 100%;
    max-height: 220px;
    object-fit: contain;
    margin-bottom: 6px;
    border: 1px solid #ddd;
}

.article p {
    font-size: 11.5px;
    line-height: 1.65;
    white-space: pre-wrap;
}
</style>
</head>

<body>

<div id="ui">
    <h3>üì∞ ‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç ‚Äì Newspaper Generator</h3>
    <input type="file" id="zipInput" accept=".zip">
</div>

<div id="paper"></div>

<script>
let imageMap = {};

zipInput.onchange = async e => {
    const zip = await JSZip.loadAsync(e.target.files[0]);
    imageMap = {};

    for (const f in zip.files) {
        if (/\.(jpg|jpeg|png)$/i.test(f)) {
            const blob = await zip.file(f).async("blob");
            imageMap[f.split("/").pop()] = URL.createObjectURL(blob);
        }
    }

    const txtFile = Object.keys(zip.files).find(f => f.endsWith(".txt"));
    const text = await zip.file(txtFile).async("text");

    const articles = parseArticles(text);
    renderPages(articles);
};

function parseArticles(text) {
    const lines = text.split(/\r?\n/);
    let articles = [];
    let buffer = "";
    let image = null;

    const push = () => {
        if (buffer.trim().length > 80) {
            articles.push({ text: buffer.trim(), image });
        }
        buffer = "";
        image = null;
    };

    lines.forEach(line => {
        line = line.replace(/^\[[^\]]+\]\s*[^:]+:\s*/, "").trim();
        if (!line) return;
        if (/image omitted|^end$/i.test(line)) return;

        const img = line.match(/<attached:\s*(.*?\.(jpg|jpeg|png))/i);
        if (img) {
            image = imageMap[img[1]];
            return;
        }

        if (line.length < 60 && buffer.length > 350) push();
        buffer += line + "\n";
    });

    push();
    return articles;
}

function titleFrom(text) {
    return text.split("\n")[0].slice(0, 65);
}

function renderPages(articles) {
    paper.innerHTML = "";
    let page;
    let col;

    articles.forEach((a, i) => {
        if (!page || col.scrollHeight > col.clientHeight) {
            page = document.createElement("div");
            page.className = "page";
            page.innerHTML = `
                <div class="header">
                    <h1>‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç</h1>
                    <div class="meta">
                        <span>VOL 01</span>
                        <span>${new Date().toLocaleDateString('te-IN')}</span>
                        <span>‡∞™‡±á‡∞ú‡±Ä</span>
                    </div>
                </div>
                <div class="columns"></div>
            `;
            paper.appendChild(page);
            col = page.querySelector(".columns");
        }

        const art = document.createElement("div");
        art.className = "article";
        art.innerHTML = `
            <h2>${titleFrom(a.text)}</h2>
            ${a.image ? `<img src="${a.image}">` : ""}
            <p>${a.text}</p>
        `;
        col.appendChild(art);
    });
}
</script>

</body>
</html>
