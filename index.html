<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Janam News - ZIP Newspaper Generator (FIXED)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans Telugu', sans-serif; 
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); 
        }
        .app { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 25px; 
            box-shadow: 0 25px 80px rgba(0,0,0,0.25); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(45deg, #dc2626, #b91c1c); 
            color: white; 
            padding: 50px; 
            text-align: center; 
        }
        .header h1 { font-size: 3rem; font-weight: 700; }
        .drop-zone { 
            border: 5px dashed #3b82f6; 
            border-radius: 20px; 
            padding: 80px; 
            text-align: center; 
            margin: 50px; 
            cursor: pointer; 
            transition: all 0.3s;
            background: rgba(255,255,255,0.9);
        }
        .drop-zone.dragover { 
            border-color: #10b981; 
            background: #ecfdf5; 
            transform: scale(1.02); 
        }
        .dual-panel { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 40px; 
            padding: 50px; 
        }
        @media (max-width: 992px) { 
            .dual-panel { grid-template-columns: 1fr; } 
        }
        .panel { 
            background: #f8fafc; 
            border-radius: 20px; 
            padding: 40px; 
            height: 700px; 
            overflow-y: auto; 
        }
        .story-item { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border-left: 5px solid #3b82f6;
        }
        .story-sender { 
            font-weight: 700; 
            color: #1e40af; 
            font-size: 1.2rem; 
        }
        .story-text { 
            line-height: 1.8; 
            margin: 15px 0; 
        }
        .story-image { 
            width: 100%; 
            height: 250px; 
            object-fit: cover; 
            border-radius: 12px; 
            margin: 15px 0; 
        }
        .end-marker { 
            background: #10b981; 
            color: white; 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-weight: 700; 
            display: inline-block; 
        }
        .newspaper-preview { 
            column-count: 3; 
            column-gap: 30px; 
        }
        .page-hero { 
            grid-column: 1 / -1; 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white; 
            padding: 50px; 
            border-radius: 20px; 
            margin-bottom: 40px; 
            text-align: center; 
        }
        .print-btn, .zip-btn { 
            background: linear-gradient(45deg, #ec4899, #db2777); 
            border: none; 
            color: white; 
            padding: 20px 60px; 
            font-size: 1.5rem; 
            border-radius: 50px; 
            font-weight: 700; 
        }
        .error-msg {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            border-left: 5px solid #dc2626;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üì∞ ‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç - ZIP ‡∞®‡±Å‡∞Ç‡∞°‡∞ø NEWSPAPER (FIXED)</h1>
            <p>‡∞Æ‡±Ä ZIP file upload ‚Üí AI stories extract ‚Üí Perfect Telugu newspaper!</p>
        </div>

        <div class="drop-zone p-5 m-5" id="dropZone">
            <h2>üì¶ ZIP File ‡∞á‡∞ï‡±ç‡∞ï‡∞° Drop ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</h2>
            <p>chat.txt + images (.jpg files) ‚Üí Auto newspaper generation</p>
            <div id="loadingSpinner" style="display: none; font-size: 1.2rem;">
                <div class="loading"></div> Processing your ZIP...
            </div>
            <div id="errorMsg" class="error-msg" style="display: none;"></div>
            <input type="file" id="zipInput" accept=".zip" style="display: none;">
            <button class="btn btn-primary btn-lg mt-4 px-5" onclick="document.getElementById('zipInput').click()">
                ZIP File Select ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø
            </button>
        </div>

        <div class="dual-panel">
            <!-- LEFT: Extracted Stories -->
            <div class="panel">
                <h3>üìã Extracted Stories <span id="storyCount">({0})</span></h3>
                <div id="storiesList"></div>
            </div>

            <!-- RIGHT: Newspaper Preview -->
            <div class="panel">
                <h3>üóûÔ∏è AI Newspaper Layout</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                    <button class="print-btn me-3" id="printBtn" style="display: none;">üñ®Ô∏è PDF PRINT ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</button>
                    <button class="zip-btn" id="zipBtn" style="display: none;">üì¶ ZIP EXPORT</button>
                </div>
                <div id="newspaperPreview" class="newspaper-preview"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        let extractedStories = [];
        let imageMap = {};
        let originalImages = {};

        // FIXED Drop zone
        const dropZone = document.getElementById('dropZone');
        const zipInput = document.getElementById('zipInput');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMsg = document.getElementById('errorMsg');

        // Event handlers with proper error handling
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
            dropZone.addEventListener(event, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(event => {
            dropZone.addEventListener(event, highlight, false);
        });
        ['dragleave', 'drop'].forEach(event => {
            dropZone.addEventListener(event, unhighlight, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dropZone.classList.remove('dragover');
        }

        dropZone.addEventListener('drop', handleDrop);
        zipInput.addEventListener('change', handleZip);

        async function handleDrop(e) {
            e.stopPropagation();
            const files = Array.from(e.dataTransfer.files);
            if (files.length === 0) return;
            
            showLoading(true);
            hideError();
            await processZip(files[0]);
            showLoading(false);
        }

        async function handleZip(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            e.target.value = ''; // Reset input
            showLoading(true);
            hideError();
            await processZip(file);
            showLoading(false);
        }

        function showLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }

        function hideError() {
            errorMsg.style.display = 'none';
        }

        // FIXED ZIP Processing
        async function processZip(zipFile) {
            try {
                console.log('Processing ZIP:', zipFile.name, zipFile.size);
                
                if (!zipFile || !zipFile.name.toLowerCase().endsWith('.zip')) {
                    throw new Error('ZIP file ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á upload ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø');
                }

                if (zipFile.size === 0) {
                    throw new Error('ZIP file ‡∞ñ‡∞æ‡∞≥‡±Ä‡∞ó‡∞æ ‡∞â‡∞Ç‡∞¶‡∞ø');
                }

                // Verify JSZip is loaded
                if (typeof JSZip === 'undefined') {
                    throw new Error('JSZip library load ‡∞Ö‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‡∞ï‡∞æ‡∞¶‡±Å. Page refresh ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø');
                }

                const zip = await JSZip.loadAsync(zipFile);
                console.log('ZIP loaded successfully. Files count:', Object.keys(zip.files).length);
                
                imageMap = {};
                originalImages = {};

                // Extract images FIRST
                console.log('Extracting images...');
                let imageCount = 0;
                for (const filename of Object.keys(zip.files)) {
                    if (filename.match(/\.(jpg|jpeg|png|gif)$/i)) {
                        try {
                            const blob = await zip.file(filename).async('blob');
                            imageMap[filename.toLowerCase()] = URL.createObjectURL(blob);
                            originalImages[filename.toLowerCase()] = blob;
                            imageCount++;
                            console.log('Image added:', filename);
                        } catch (imgError) {
                            console.warn('Image load error:', filename, imgError);
                        }
                    }
                }
                console.log(`Found ${imageCount} images`);

                // Find chat.txt - FIXED detection
                const chatFiles = Object.keys(zip.files).filter(f => 
                    f.toLowerCase().includes('chat') || 
                    f.toLowerCase().includes('txt') ||
                    f.toLowerCase().includes('message')
                );
                
                if (chatFiles.length === 0) {
                    throw new Error('chat.txt ‡∞≤‡±á‡∞¶‡∞æ messages.txt file ZIP ‡∞≤‡±ã ‡∞≤‡±á‡∞¶‡±Å');
                }

                const chatFile = chatFiles[0];
                console.log('Found chat file:', chatFile);
                
                const chatContent = await zip.file(chatFile).async('text');
                console.log('Chat content length:', chatContent.length);
                
                extractedStories = parseJanamNewsChat(chatContent);
                console.log('Parsed stories:', extractedStories.length);

                if (extractedStories.length === 0) {
                    throw new Error('Stories parse ‡∞ï‡∞æ‡∞≤‡±á‡∞¶‡±Å. Chat format check ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø');
                }
                
                renderStories();
                generateNewspaper();
                document.getElementById('printBtn').style.display = 'inline-block';
                document.getElementById('zipBtn').style.display = 'inline-block';
                
            } catch (error) {
                console.error('ZIP process error:', error);
                showError('ZIP Error: ' + error.message);
                extractedStories = [];
                imageMap = {};
                renderStories();
            }
        }

        function parseJanamNewsChat(content) {
            const lines = content.split('\n');
            let currentStory = { sender: '', text: '', images: [], timestamp: '' };
            const stories = [];

            lines.forEach(line => {
                line = line.trim();
                if (!line || line.length < 10) return;

                // Multiple chat formats support
                let match = line.match(/\[(\d{1,2}\/\d{1,2}\/\d{2}),\s*(\d{1,2}:\d{1,2}:\d{1,2}\s*(?:AM|PM))\]\s*~\s*([^:]+?):\s*(.*)/i);
                if (!match) {
                    match = line.match(/(\d{1,2}\/\d{1,2}\/\d{2})\s+(\d{1,2}:\d{1,2}:\d{1,2})\s+([^:]+?):\s*(.*)/i);
                }
                if (!match) {
                    match = line.match(/\[?(.*?)\]?\s*([^:]+?):\s*(.*)/i);
                }

                if (match) {
                    const timestamp = match[1] || match[2] || 'Unknown';
                    const sender = (match[3] || match[2] || '').trim();
                    let message = (match[4] || match[3] || '').trim();

                    // END markers
                    if (message.match(/üîö|END|end|üì©üì©üîö|STOP/i)) {
                        if (currentStory.text.trim().length > 30) {
                            currentStory.timestamp = timestamp;
                            stories.push(currentStory);
                        }
                        currentStory = { sender: '', text: '', images: [], timestamp: '' };
                    } else {
                        if (!currentStory.sender) currentStory.sender = sender;
                        
                        // Image detection
                        const imgMatch = message.match(/<attached:\s*([^>]+?\.(jpg|jpeg|png|gif))/i) ||
                                       message.match(/image[:\s]*([^\s]+?\.(jpg|jpeg|png|gif))/i);
                        
                        if (imgMatch) {
                            const imgName = imgMatch[1].toLowerCase().trim();
                            if (imageMap[imgName]) {
                                currentStory.images.push(imageMap[imgName]);
                            }
                        }
                        
                        currentStory.text += message + ' ';
                    }
                }
            });

            return stories
                .filter(s => s.text.trim().length > 50)
                .sort((a, b) => b.text.length - a.text.length)
                .slice(0, 15);
        }

        function renderStories() {
            const container = document.getElementById('storiesList');
            document.getElementById('storyCount').textContent = `(${extractedStories.length})`;
            
            if (extractedStories.length === 0) {
                container.innerHTML = '<div class="text-center p-5 text-muted">ZIP process ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</div>';
                return;
            }

            container.innerHTML = extractedStories.map((story, index) => `
                <div class="story-item">
                    <div class="story-sender">${index + 1}. ${story.sender}</div>
                    <div class="story-text">${story.text.trim().substring(0, 300)}${story.text.length > 300 ? '...' : ''}</div>
                    ${story.images.slice(0,2).map(img => `<img src="${img}" class="story-image" alt="Story image">`).join('')}
                    <div class="end-marker mt-3">üîö END</div>
                    <small class="d-block mt-2 text-muted">${story.timestamp} | ${story.text.length} chars</small>
                </div>
            `).join('');
        }

        function generateNewspaper() {
            const preview = document.getElementById('newspaperPreview');
            if (extractedStories.length === 0) {
                preview.innerHTML = '<div class="text-center p-5"><h4>ZIP upload ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</h4></div>';
                return;
            }

            const topStory = extractedStories[0];
            let html = `
                <div class="page-hero">
                    <h1>${topStory.sender}</h1>
                    <div style="font-size:1.3rem; margin:30px 0;">${topStory.text.substring(0, 400)}...</div>
                    ${topStory.images.slice(0,1).map(img => `<img src="${img}" style="width:100%;height:300px;object-fit:cover;border-radius:15px;">`).join('')}
                </div>
            `;

            extractedStories.slice(1).forEach((story, index) => {
                html += `
                    <div style="break-inside: avoid; margin-bottom: 30px;">
                        <h4 style="color:#dc2626;">${story.sender}</h4>
                        <div style="line-height:1.8;">${story.text.substring(0, 250)}...</div>
                        ${story.images.slice(0,1).map(img => `<img src="${img}" style="width:100%;height:200px;object-fit:cover;border-radius:10px;margin-top:15px;">`).join('')}
                        <div style="color:#666;font-size:0.9rem;">${story.timestamp}</div>
                    </div>
                `;
            });

            preview.innerHTML = html;
        }

        // FIXED PDF Print
        document.getElementById('printBtn').onclick = async function() {
            const rightPanel = document.querySelector('.panel:last-child');
            try {
                const canvas = await html2canvas(rightPanel, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('janam-news.pdf');
            } catch (e) {
                showError('PDF Error: ' + e.message);
            }
        };

        // FIXED ZIP Export
        document.getElementById('zipBtn').onclick = async function() {
            try {
                const zip = new JSZip();
                
                // Add stories as text files
                extractedStories.forEach((story, i) => {
                    zip.file(`story-${i+1}-${story.sender.replace(/[^a-z0-9]/gi, '_')}.txt`, 
                        `Sender: ${story.sender}\nTime: ${story.timestamp}\n\n${story.text.trim()}`);
                });

                // Add original images
                Object.entries(originalImages).forEach(([name, blob]) => {
                    zip.file(name, blob);
                });

                const content = await zip.generateAsync({type: "blob"});
                saveAs(content, `janam-news-${Date.now()}.zip`);
                
            } catch (e) {
                showError('ZIP Export Error: ' + e.message);
            }
        };
    </script>
</body>
</html>
