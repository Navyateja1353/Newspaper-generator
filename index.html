<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Janam News - ZIP Newspaper Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;500;700&display=swap');

        body { 
            font-family: 'Noto Sans Telugu', sans-serif; 
            background: #f0f2f5; 
            padding: 20px;
        }

        .app-container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }

        .header { 
            background: #b91c1c; 
            color: white; 
            padding: 30px; 
            text-align: center; 
            border-bottom: 5px solid #000;
        }

        /* Drop Zone Styling */
        .drop-zone { 
            border: 3px dashed #cbd5e1; 
            border-radius: 15px; 
            padding: 40px; 
            text-align: center; 
            margin: 20px; 
            transition: 0.3s; 
            background: #f8fafc;
        }
        .drop-zone.dragover { border-color: #ef4444; background: #fee2e2; }

        /* Dual Panel Layout */
        .main-content { 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 20px; 
            padding: 20px; 
        }

        /* Left Panel: Raw Data */
        .data-panel { 
            background: #f1f5f9; 
            padding: 20px; 
            border-radius: 10px; 
            height: 800px; 
            overflow-y: auto; 
            border: 1px solid #ddd;
        }

        /* Right Panel: Newspaper Preview */
        .newspaper-container { 
            background: white; 
            padding: 40px; 
            border: 2px solid #000; /* Outer Border */
            height: 800px; 
            overflow-y: auto;
            position: relative;
        }

        /* Newspaper Styling */
        .newspaper-header {
            text-align: center;
            border-bottom: 4px double #000;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .newspaper-columns { 
            column-count: 2; 
            column-gap: 40px; 
            column-rule: 1px solid #ddd; /* Vertical Divider Border */
        }

        .story-card { 
            break-inside: avoid; 
            margin-bottom: 30px; 
            padding-bottom: 20px; 
            border-bottom: 1px solid #eee; /* Bottom border for stories */
        }

        .headline { 
            color: #000; 
            font-weight: 700; 
            font-size: 1.5rem; 
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .story-img { 
            width: 100%; 
            height: auto; 
            margin: 10px 0; 
            border: 1px solid #ccc; 
            padding: 3px;
        }

        .print-btn { 
            position: sticky;
            top: 10px;
            z-index: 100;
            background: #10b981; 
            border: none; 
            color: white; 
            padding: 10px 25px; 
            border-radius: 5px; 
            font-weight: bold;
            margin-bottom: 20px;
        }

        @media (max-width: 992px) {
            .main-content { grid-template-columns: 1fr; }
            .newspaper-columns { column-count: 1; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>üì∞ ‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç (Janam News)</h1>
        <p>Transforming ZIP archives into Digital Newspapers</p>
    </div>

    <div class="drop-zone" id="dropZone">
        <h3>üì¶ Drag & Drop ZIP File Here</h3>
        <p>Or click to select files</p>
        <input type="file" id="zipInput" accept=".zip" style="display: none;">
        <button class="btn btn-dark mt-2" onclick="document.getElementById('zipInput').click()">Browse Files</button>
    </div>

    <div class="main-content">
        <div class="data-panel">
            <h4 class="mb-4">üì• Extracted Feed</h4>
            <div id="storiesList"></div>
        </div>

        <div class="newspaper-view">
            <button class="print-btn" id="printBtn" style="display: none;">üñ®Ô∏è Export PDF</button>
            <div id="newspaperPreview" class="newspaper-container">
                <div class="newspaper-header">
                    <h1 style="font-size: 3.5rem; margin: 0;">‡∞ú‡∞®‡∞Ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç</h1>
                    <div style="display: flex; justify-content: space-between; border-top: 1px solid #000; padding: 5px;">
                        <span>‡∞∏‡∞Ç‡∞™‡±Å‡∞ü‡∞ø 1</span>
                        <span id="currentDate">Date: --/--/----</span>
                        <span>Price: Free</span>
                    </div>
                </div>
                <div id="newspaperBody" class="newspaper-columns">
                    <p style="text-align: center; color: #999; margin-top: 50px;">Upload a ZIP to generate the layout.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let extractedStories = [];
    let imageMap = {};

    const zipInput = document.getElementById('zipInput');
    const dropZone = document.getElementById('dropZone');

    // Handle File Selection
    zipInput.addEventListener('change', e => processZip(e.target.files[0]));
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        processZip(e.dataTransfer.files[0]);
    });

    async function processZip(zipFile) {
        if (!zipFile || !zipFile.name.endsWith('.zip')) return alert('Please upload a ZIP file.');
        
        try {
            const zip = await JSZip.loadAsync(zipFile);
            imageMap = {};

            // 1. Extract Images
            for (const filename of Object.keys(zip.files)) {
                if (filename.match(/\.(jpg|jpeg|png|gif)$/i)) {
                    const blob = await zip.file(filename).async('blob');
                    imageMap[filename] = URL.createObjectURL(blob);
                }
            }

            // 2. Extract Chat Text
            const chatFile = Object.keys(zip.files).find(f => f.toLowerCase().includes('chat.txt') || f.toLowerCase().includes('txt'));
            if (!chatFile) return alert('No text file found in ZIP.');

            const content = await zip.file(chatFile).async('text');
            parseStories(content);
            
            document.getElementById('printBtn').style.display = 'block';
            document.getElementById('currentDate').innerText = "Date: " + new Date().toLocaleDateString();
        } catch (err) {
            console.error(err);
            alert('Error processing ZIP.');
        }
    }

    function parseStories(content) {
        const lines = content.split('\n');
        let currentStory = { sender: '', text: '', images: [] };
        extractedStories = [];

        lines.forEach(line => {
            const match = line.match(/\[(.*?)\]\s*~\s*([^:]+?):\s*(.*)/);
            if (match) {
                const sender = match[2].trim();
                const msg = match[3].trim();

                if (msg.match(/üîö|END|end/i)) {
                    if (currentStory.text) extractedStories.push(currentStory);
                    currentStory = { sender: '', text: '', images: [] };
                } else {
                    if (!currentStory.sender) currentStory.sender = sender;
                    
                    const imgMatch = msg.match(/<attached:\s*([^>]+)>/i);
                    if (imgMatch && imageMap[imgMatch[1].trim()]) {
                        currentStory.images.push(imageMap[imgMatch[1].trim()]);
                    } else {
                        currentStory.text += msg + " ";
                    }
                }
            }
        });
        
        renderUI();
    }

    function renderUI() {
        // Render Sidebar
        document.getElementById('storiesList').innerHTML = extractedStories.map((s, i) => `
            <div class="card mb-2 p-2 shadow-sm">
                <strong>${i+1}. ${s.sender}</strong>
                <small class="text-muted">${s.text.substring(0, 50)}...</small>
            </div>
        `).join('');

        // Render Newspaper
        const body = document.getElementById('newspaperBody');
        body.innerHTML = extractedStories.map(s => `
            <div class="story-card">
                <div class="headline">${s.sender}</div>
                ${s.images[0] ? `<img src="${s.images[0]}" class="story-img">` : ''}
                <p style="text-align: justify; font-size: 0.95rem;">${s.text}</p>
            </div>
        `).join('');
    }

    // PDF Export
    document.getElementById('printBtn').onclick = async () => {
        const element = document.getElementById('newspaperPreview');
        const { jsPDF } = window.jspdf;
        const canvas = await html2canvas(element, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const width = pdf.internal.pageSize.getWidth();
        const height = (canvas.height * width) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, width, height);
        pdf.save('janam-news.pdf');
    };
</script>

</body>
</html>
